<!DOCTYPE html>
<html>
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>High On Track</title>
		<style>
			progress::-moz-progress-bar { background: #ffffff; }
			progress::-webkit-progress-value { background-color: #ffffff;}
			progress::-webkit-progress-bar { background-color: #2d2d2d;}
			progress { background-color: #2d2d2d; color: #ffffff; width: 50%; height: 16px;}
			.center {
				width: 100%;
				height: 100%;
				position: absolute;
				display: grid;
				grid-template-columns: 100%;
				align-items: center;
				justify-content: center;
			}
		</style>
		<!-- Yandex Games SDK -->
		<script src="https://yandex.ru/games/sdk/v2"></script>
			
		<script>
			let ysdk;
			let is_ready = false;
			let ready_before_init = false;
			
			function initGame() {
				YaGames
				.init()
				.then(_sdk => {
					ysdk = _sdk;
					console.log("YandexSDK: initialization finished");

					//If game was ready to interact before SDK initialization, calling ready
					if (ready_before_init) {
						Ready();
					}

					onResize();
				})
				.catch(console.error);
			}
			
			function Ready() {
				if (is_ready) {
					return;
				};

				if (ysdk  != null && is_ready == false){
					ysdk.features.LoadingAPI?.ready();
					is_ready = true;
					console.log("YandexSDK: ready to interact");
				} else {
					ready_before_init = true;
					console.log("YandexSDK: ready called before initialization finished");
				};
			}

			function isDesktop() {
				//if (ysdk != null) { return ysdk.deviceInfo.isDesktop(); } else { }
				var result = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
				return !result;
			}

			function isSdkInitialized() {
				return ysdk != null;
			}

			function ShowFullscreenAd(callback) {
				if (ysdk == null) {
					callback('onErrorCallback');
					console.log("YandexSDK: yandex sdk has not been initialized");
					return;
				};

				ysdk.adv.showFullscreenAdv({
					callbacks: {
						onOpen: () => {
							callback('onOpenCallback');
							console.log('YandexSDK: fullscreen ad open');
						},
						onClose: () => {
							callback('onCloseCallback');
							console.log('YandexSDK: fullscreen ad closed');
						},
						onError: (e) => {
							callback('onErrorCallback');
							console.log('YandexSDK: fullscreen ad Error: ', e);
						},
						onOffline: () => {
							callback('onOfflineCallback');
							console.log('YandexSDK: fullscreen ad Offline');
						}
					}
				});
			}

			function ShowRewardedAd(callback) {
				if (ysdk == null) {
					callback('onErrorCallback');
					console.log("YandexSDK: yandex sdk has not been initialized");
					return;
				};

				ysdk.adv.showRewardedVideo({
					callbacks: {
						onOpen: () => {
							callback('onOpenCallback');
							console.log('YandexSDK: video ad open.');
						},
						onRewarded: () => {
							callback('onRewardedCallback');
							console.log('YandexSDK: rewarded');
						},
						onClose: () => {
							callback('onCloseCallback');
							console.log('YandexSDK: video ad closed');
						}, 
						onError: (e) => {
							callback('onErrorCallback');
							console.log('YandexSDK: error while open video ad:', e);
						}
					}
				});
			}

			function RequestReview(callback) {
				if (ysdk == null) {
					callback('onRequestReviewError');
					console.log("YandexSDK: yandex sdk has not been initialized");
					return;
				};

				ysdk.feedback.canReview()
					.then(({ value, reason }) => {
						if (value) {
							ysdk.feedback.requestReview()
								.then(({ feedbackSent }) => {
									callback('onRequestReviewCompleted');
									console.log("YandexSDK: review request completed");
								})
						} else {
							callback('onRequestReviewError');
							console.log("YandexSDK: review request failed: " + reason);
						}
					});
			}
			
		</script>
    </head>
    <body style="margin:0; background-color:black; overflow: hidden;">
		<!-- Game downloading progress -->
		<div id="loading" class="center">
			<div style="width: 100%; height: auto; text-align: center;">
				<img src="index.png" style="width: 25%; height: 25%;"> <br>
				<progress id="loading-bar" max="100" value="0"></progress>
			</div>
		</div>
		<!-- Engine start-up -->
		<canvas id="godot-canvas" style="width:100%;height:100%; outline: none;" width="1280" height="720" tabindex="0"></canvas> 
		<script src="index.js"></script>
		<script>
			const godotCanvas = document.querySelector("#godot-canvas");
			var progress_bar = null;

			window.addEventListener("resize", onResize);
			
			var engine = new Engine({"args":[],"canvasResizePolicy":0,"executable":"index","experimentalVK":false,"fileSizes":{"index.pck":5997440,"index.wasm":19761972},"focusCanvas":true,"gdnativeLibs":[]});
			engine.startGame({ canvas: godotCanvas, unloadAfterInit: true, onProgress: displayProgress });

			onResize();

			godotCanvas.style.display = "none";
			
			function displayProgress(current, total) {
				if (progress_bar == null) {
					progress_bar = document.getElementById("loading-bar");
					return;
				}
				
				progress_bar.value = current;
				progress_bar.max = total;

				if (current == total) {
					hideLoading()
				}
			}

			function hideLoading() {
				var progress_div = document.getElementById("loading");
				progress_div.style.display = "none";
				godotCanvas.style.display = "";
			}

			function onResize() {
				if (isDesktop()) {
					godotCanvas.width = window.innerWidth;
					godotCanvas.height = window.innerHeight;
				} else {
					var aspect_ratio = window.innerWidth / window.innerHeight;
					godotCanvas.width = Math.round(720 * aspect_ratio);
					godotCanvas.height = 720;
				}
			}

			function focusEvents(callback) {
				document.addEventListener('visibilitychange', function() {
					if(document.visibilityState == 'hidden') {
						console.log("Document blur");
						callback('blur');
					} else {
						console.log("Document focus");
						callback('focus');
					}
				});
			}

			function focusCanvas() {
				setTimeout(() => {
					console.log("Canvas focus request");
					window.focus();
					godotCanvas.focus();
				}, "50");
			}

			function getLocale() {
				const queryString = window.location.search;
				const urlParams = new URLSearchParams(queryString);
				if (urlParams.has('lang')){
					return urlParams.get('lang');
				}
				return "";
			}

		</script>
    </body>
</html>
